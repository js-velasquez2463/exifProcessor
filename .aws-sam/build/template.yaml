AWSTemplateFormatVersion: '2010-09-09'
Description: exifProcessor
Transform:
- AWS::Serverless-2016-10-31
Resources:
  helloFromLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/exifHandler.getMetadataHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A Lambda function that returns a static string.
      Policies:
      - AWSLambdaBasicExecutionRole
      - S3ReadPolicy:
          BucketName: images-tfm2
      - Statement:
        - Effect: Allow
          Action:
          - s3:GetObject
          - s3:ListBucket
          Resource:
          - arn:aws:s3:::images-tfm2/*
          - arn:aws:s3:::images-tfm2
      Events:
        ProcessExifEvent:
          Type: Api
          Properties:
            Path: /processExif
            Method: post
      CodeUri: helloFromLambdaFunction
    Metadata:
      SamResourceId: helloFromLambdaFunction
  imageMetadataRemovalFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/exifHandler.deleteMetadataHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A Lambda function that deletes the metadata of an image and upload
        it in a new file.
      Policies:
      - AWSLambdaBasicExecutionRole
      - S3ReadPolicy:
          BucketName:
            Ref: S3Bucket
      - S3WritePolicy:
          BucketName:
            Ref: S3Bucket
      Events:
        DeleteExifMetadataEvent:
          Type: Api
          Properties:
            Path: /deleteExif
            Method: post
      CodeUri: imageMetadataRemovalFunction
    Metadata:
      SamResourceId: imageMetadataRemovalFunction
  getImageFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/exifHandler.getImageHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
      MemorySize: 128
      Timeout: 100
      Description: A Lambda function that gets the signed image url to download
      Policies:
      - AWSLambdaBasicExecutionRole
      - S3ReadPolicy:
          BucketName:
            Ref: S3Bucket
      - S3WritePolicy:
          BucketName:
            Ref: S3Bucket
      Events:
        GetImageEvent:
          Type: Api
          Properties:
            Path: /getImage
            Method: post
      CodeUri: getImageFunction
    Metadata:
      SamResourceId: getImageFunction
  imageUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/exifHandler.uploadImageHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
      MemorySize: 128
      Timeout: 100
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - s3:PutObject
          Resource:
          - arn:aws:s3:::images-tfm2/*
          - arn:aws:s3:::images-tfm2
      - AWSLambdaBasicExecutionRole
      - S3ReadPolicy:
          BucketName:
            Ref: S3Bucket
      - S3WritePolicy:
          BucketName:
            Ref: S3Bucket
      Events:
        UploadImageEvent:
          Type: Api
          Properties:
            Path: /uploadImage
            Method: post
      CodeUri: imageUploadFunction
    Metadata:
      SamResourceId: imageUploadFunction
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: images-tfm2
Outputs:
  ExifRemovalApi:
    Description: API Gateway endpoint URL for Prod stage
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/remove-metadata/
